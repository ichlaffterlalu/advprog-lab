# Tutorial 8: Concurrency

CSCM602023 Advanced Programming @ Faculty of Computer Science Universitas
Indonesia, Term 2 2017/2018

* * *

Your main task in this tutorial is to complete the implementation over a feature
that requested. In this tutorial you will not given any starter unit test and also 
you are not required to implement the unit test, as the difficulty of concurrency problem
is somewhat make the unit test become a difficult task.

The problem set used in this tutorial is customized from basic example to show
how concurrency work in Java. You may search it on Google or find some Java 
programming book to understand better about concurrency. You also need to make
sure that you understand what is concurrency to have a better perspective about
why concurrency is important to learn. 

The evaluation of your work will be based on implementation over requested feature,
code style issues, and your understanding on Java's concurrency. 
Code style issues can be checked from test report generated by Gradle. 
Your understanding will be verified by teaching team during in-person demo 
session and/or merge request review.

## Mandatory Tasks Description

Suppose that we are the main seller for some concert ticketing. To make sure
that you are not "Invaded" by the customer to your office, you decided that to
buy the ticket, the customer must buy it from 5 online ticketing website that
you already appointed. By doing this, you're also hoping that the ticket will
sold out quicker.

The problem is, sometime there is a mismatch between the sum of requested ticket
from each of distributor and our tally counter that write how many ticket requested
in total from each distributor. This problem can be seen if you run the main class
at `java.tallycounter` Package.

Your job is to create a new `TallyCounter` class that implement concurrency in
this Tally Counter problem. Meaning that, if we use your new `TallyCounter` class
the sum of requested ticket and the tally counter will have the sum number of tickets
that needs to be produced.


## Additional Tasks 

The `Story` section will tell you about a brief story of the template code, and
the `Requested Feature` section will tell you about the changes or the new features that you 
need to implement to the template code. There are also additional task 
that are defined in `Code Styling` and `Reflection on Concurrency` section.


### Story

Now, we're focused on another example of concurrency problem. As you can see
in package `java.game` there are 2 classes that already provided. These classes
are a foundation of a Math Quiz that you need to implement. Here are the intial rules of
the quiz :

1. There are 10 math problem (fraction arithmetic) that will be generated randomly
2. You need to define how much time you need to answer 1 problem (in second), let us denote this by *N*
3. After you define *N*, then you're going to answer each question one by one with following property:
    - If you answer it correctly, and within *N* time limit, you get 10 points
    - If you answer it correctly, and after *N* time limit, you get 5 points
    - If you answer it wrong, you get 0 point regardless of the time limit
4. At the end of the game, the total of the score will be displayed

Tips : You have to try the quiz first to understand more

### Requested Feature

Now you need to implement *additional rule* for the quiz:

1. We will giving a default score *100 points* in the begining of the quiz
2. This point will be reduced 1 point every second of the game
3. After answering, there are new rule for calculating new score :
    - Instead of giving 10 points, answering correctly within within *N* time limit
    will give you additional 10% points of the current score
    - Instead of giving 10 points, answering correctly within within *N* time limit
    will give you additional 5% points of the current score
    - If you answer it wrong, you get 0 point regardless of the time limit
    - After each answer, you need to display *the current score after the player answering the problem*,
    and *total time needed to answer the problem*.
4.  At the end of the game, the total of the score and the total time needed to answer all
the problem will be displayed

Use at minimum 2 Thread to implement this new feature, 1<sup>st</sup> is for the
quiz timer and decreasing the score each seconds, and 2<sup>nd</sup> is for 
generating the quiz problem sets.
 
### Reflect on Concurrency

Please write a short paragraph (3 - 5 sentences) that describe your experience
in concurrency based on what you learn in *Mandatory* and  *Additional* task. 
You are allowed to write more than 1 paragraph.

## Running & Testing the Program

It is recommended to use IDE that can import Gradle-based project to complete this
tutorial. If you are using IDE, **please import `build.gradle` located in the
parent directory (root) of this tutorial.** The tutorials are structured as
Gradle multi-projects and the content of `build.gradle` in each tutorial
directories is defined in the main (root) `build.gradle` file.

> For Eclipse users: If you are using Eclipse, you might want to generate
> Eclipse project file for this tutorial and import it into Eclipse.
> Before starting the tutorial, you can invoke `gradle :tutorial-8:eclipse`
> to create the Eclipse project file.

You can run the unit tests by executing `test` Gradle task from your IDE. If you
prefer terminal/shell:

```bash
gradle :tutorial-8:test
```

> Explanation: Run `test` task available in `tutorial-8` Gradle (sub)project

If you want to run code linter (Checkstyle) to check find code style issues in
your work, execute `checkstyleMain` or `checkstyleTest` Gradle task from your IDE
or via terminal/shell:

```bash
gradle :tutorial-8:checkstyleMain
gradle :tutorial-8:checkstyleTest
```

> Explanation: Run `checkstyleMain` and `checkstyleTest` tasks available in
> `tutorial-8` Gradle (sub)project

> Tips: You can also find Checkstyle plugin for your IDE of choice and let
> the plugin handle the checking. Do not forget to configure the plugin to
> use `google_csui_checks.xml` Checkstyle configuration in the `config`
> directory.

> Tips: You can run both linter and unit tests sequentially by executing `check`
> Gradle task. If you prefer terminal/shell: `gradle :tutorial-8:check`

You can also create code coverage report by running `jacocoTestReport` Gradle
task after executing `check`. The report will be written in
`/build/reports/jacoco/test/html` as a HTML file.

```bash
gradle :tutorial-8:check
gradle :tutorial-8:jacocoTestReport
```

## Mandatory Tasks Checklist

- [x] Make sure that you have at least 1 commit for each exercises that contain
changes to the code after refactoring
- [x] Explain in your `My Notes` Section in this README, why at the first template code,
the initial Tally Counter cannot have the exact number of ordered ticket (Relate it to
the declaration of `c++` and `c--`)
- [x] Implement the new `TallyCounter` version (e.g. `AtomicTallyCounter`) using 
`AtomicInteger` and explain why it can be the solution of this particular concurrency 
problem
- [x] Implement the new `TallyCounter` version (e.g. `SynchronizedTallyCounter`) using Java
`Synchronized` and explain why it can be the solution of this particular concurrency 
problem
- [x] Push your commits to online Git repository on your GitLab project

## Additional Tasks Checklist

- [x] Make sure there are no code style issues, both in production code and
test code
- [x] Implementing the feature as requested in the Description
- [x] Write a several sentence or paragraph about the additional task
    - Can you implement the new quiz rule without any concurrency? Explain Why?
    - Can you implement the new feature with using at minimum 1 Thread? Explain Why?

## Additional Words

I would like to thank you Ahmad Nabili (Student number 1606954691 from Information System 
extension Program, Faculty of Computer Science Universitas Indonesia) 
for the template code that he created in `Fraction` and `Main` class in Package `java.game`.

## My Notes

> Feel free to use this section to write your own notes related to your attempt
> in doing the tutorial. You can also use this section to write text for
> answering question(s) mentioned in the task checklists.

### Why the original TallyCounter gives incorrect result?

Alasan utamanya adalah bahwa setiap thread (dalam hal ini adalah OnlineTicketShop) saling
berebutan dalam mengakses dan mengubah suatu variabel di TallyCounter. Sehingga, terdapat
kemungkinan untuk terjadinya *miss* dari pendataan tiket.

Untuk ilustrasi:
```
    kondisi sekarang: 5
    thread 1: sesuatu++ // membaca sebagai 5, increment jadi 6
    thread 2: sesuatu++ // membaca sebagai 5, increment jadi 6
    kondisi berikutnya: 6
    seharusnya: 7
```

Sehingga diperlukan adanya sinkronisasi agar pekerjaan-pekerjaan tidak saling menimpa satu
sama lain.

### Why AtomicTallyCounter can be a solution for this problem?

Karena `AtomicInteger` dapat memastikan pembacaan dan penulisan tidak dilakukan pada saat
yang bersamaan (hanya bisa sekali dalam satu waktu). Hal ini dapat dilakukan karena
method get dan set yang ada pada API ini mendukung operasi atomik, yaitu operasinya
sudah tidak dapat dipecah-pecah lagi, sehingga aman bagi *multithreading* yang cenderung
memisahkan pekerjaan-pekerjaan.

### Why synchronize keyword can also be a solution?

Karena keyword `synchronized` merupakan salah satu cara untuk menghadang thread lain dalam
mengakses suatu method ketika sudah ada thread yang sedang mengakses method tersebut. Ini
akan menyebabkan tidak ada dua thread yang mengakses method yang sama secara bersamaan.

### Can the new rules for the "additional" game be implemented without any concurrence?

Tidak, karena proses input dan penghitungan waktu harus dilakukan secara bersamaan.

### Can the new rules be implemented with minimum of 1 thread?

Bisa, karena dua proses yang dilakukan secara konkuren, yaitu pengurangan skor dan pembacaan
input dapat dilakukan secara terjalin (saling terhubung/*interleaving*).

Untuk mencapai hal tersebut, dapat dilakukan iterasi hingga pembacaan selesai dilakukan
**sekaligus** mengecek waktu untuk pengurangan skor. Tentunya, hal itu dilakukan tanpa melakukan
*blocking* pada standard input.

### Any reflections about concurrency?

Tantangan utama dalam pembuatan program yang konkuren (terutama *parallelism*) adalah mengetahui
terlebih dahulu kode-kode yang dapat dijalankan secara indpenden, sehingga bisa dijalankan secara
paralel. Selain itu, perlu diperhatikan pula *cost* dari komputasi maupun memori yang diakibatkan
pembagian tugas secara *multithreading*.

Namun, pada dasarnya, untuk tutorial ini masih belum perlu untuk memikirkan dampak dari segi
biaya komputasi dan performanya. Namun, kenyataannya banyak kasus yang menjadikan kedua hal tersebut
sebagai hal yang penting untuk diperhatikan.